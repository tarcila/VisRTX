name: VisRTX CI
on:
  push:
    branches: [ next_release ]
    paths:
      - 'devices/**'
      - '.github/actions/**'
      - '.github/workflows/build-visrtx.yml'
  pull_request:
    branches: [ main, next_release ]
    paths:
      - 'devices/**'
      - '.github/actions/**'
      - '.github/workflows/build-visrtx.yml'

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [linux, windows]
        cudaversion: ['12.4.1', '13.0.2']
        config: [Release, Debug]
        include:
          - os: linux
            runs-on: ubuntu-22.04
            generator: Ninja
          - os: windows
            runs-on: windows-2022
            generator: Ninja
    runs-on: ${{ matrix.runs-on }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
      - name: Setup MSVC (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
      - name: Setup CUDA Toolkit
        uses: ./.github/actions/setup-cuda
        with:
          cuda-version: ${{ matrix.cudaversion }}
      - name: Build ANARI-SDK
        uses: ./.github/actions/build-anari-sdk
        with:
          config: ${{ matrix.config }}
          install-prefix: ${{ github.workspace }}/deps
          build-deps-path: devices/rtx/cmake/build_deps
          generator: ${{ matrix.generator }}
      - name: Configure VisRTX
        run: >
          cmake -LA -G "${{ matrix.generator }}" -B ${{github.workspace}}/build-visrtx
          -DCMAKE_BUILD_TYPE=${{ matrix.config }}
          -DCMAKE_INSTALL_PREFIX=${{github.workspace}}/install
          -DCMAKE_PREFIX_PATH=${{ github.workspace }}/deps
          -DVISRTX_BUILD_RTX_DEVICE=ON
          -DVISRTX_PRECOMPILE_SHADERS=OFF
          -DVISRTX_BUILD_GL_DEVICE=OFF
          -DVISRTX_BUILD_TSD=OFF
      - name: Install VisRTX
        run: >
          cmake --build ${{ github.workspace }}/build-visrtx --config ${{ matrix.config }} --target install --parallel
